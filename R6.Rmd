---
title: "R6 Class"
author: "Wu Gong"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    code_folding: none
    toc_depth: 6
    lightbox: true
    gallery: false
    highlight: monochrome
    css: Wu.css
---


<script type="text/javascript">
function selectElementContents(el) {
    let body = document.body, range, sel;
    if (document.createRange && window.getSelection) {
        range = document.createRange();
        sel = window.getSelection();
        sel.removeAllRanges();
        try {
            range.selectNodeContents(el);
            sel.addRange(range);
        } catch (e) {
            range.selectNode(el);
            sel.addRange(range);
        }
    } else if (body.createTextRange) {
        range = body.createTextRange();
        range.moveToElementText(el);
        range.select();
    }
    document.execCommand("Copy");}
</script>


```{r setup, echo=FALSE, cache=FALSE,warning=FALSE,message=FALSE}
library(knitr)
library(rmdformats)
library(Wu)
opts_chunk$set(echo=TRUE,
               cache=FALSE,
               eval=TRUE,
               prompt=FALSE,
               results="asis",
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               out.width = '80%',
               class.source='klippy'
               )
eval_fast <- TRUE
eval_slow <- FALSE
klippy::klippy(position = c('top', 'right')
             , tooltip_message = 'Click to copy'
             , tooltip_success = 'Done')
```



# [Index](index.html)

# R6 Object


```{r, class.source='klippy'}

library(Wu)
library(R6)
library(sloop)
library(epitools)

dt <- data.table(
  outcome = sample(c(0,1), 100, replace = TRUE)
, treatment = factor(rep(c("case", "control"), 50), levels = c("case", "control"))
, sex = factor(sample(c("F", "M"), 100, replace = TRUE), levels = c("F", "M"))
)


RR <- R6Class(
  "RR"
, list(binary = NA
     , groups = NA
     , data = NULL
     , groups_nlevels = NULL
     , tables = NULL
     , freqs = NULL
     , ors_str = NULL
     , oddsratios = NULL
     , riskratios = NULL
     , fx_or = function(x) epitools::epitab(x, method = "oddsratio", oddsratio = "wald")
     , fx_rr = function(x) epitools::epitab(x, method = "riskratio", oddsratio = "wald")
     , initialize = function(binary, groups, data) {
       self$binary <- binary
       self$groups <- groups
       vars <- c(binary, groups)
       self$data <- data[, ..vars]
       self$groups_nlevels <- lapply(groups, function(x) length(levels(self$data[[x]])))
       self$tables <- lapply(self$groups, function(x) table(self$data[[x]], self$data[[self$binary]]))
       self$freqs <- lapply(self$groups, function(x) Wu::tab_freq(self$binary, x, self$data))
       self$ors_str <- Wu::get_ors(self$binary, self$groups, self$data)
       self$oddsratios <- lapply(self$tables, self$fx_or)
       self$riskratios <- lapply(self$tables, self$fx_rr)
     }
     ))



RR1 <- RR$new(binary = "outcome", groups = c("treatment", "sex"), data = dt)




add_copy_icon <- function(id){
  txt <- paste0('<button type=\"button\" onclick=\"selectElementContents( document.getElementById('
              , '\''
              , id
              , '\''
              , ') );\">Copy Table</button>')
  cat(txt)
}

add_copy_icon("t1")
RR1$oddsratios[[2]]$tab %>%
   prt(table.attr="id=t1", caption = "Table of Odds Ratio")





library(DT)
dt <- RR1$oddsratios[[2]]$tab
dt <- as.data.frame(dt)
dt <- round(dt, 4)

datatable(dt
, extensions = 'Buttons'
, options = list(
    dom = 'Bfrtip'
  , buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
  )
  , caption = "Odds Ratios"
)

```



<!-- <button type="button" onclick="selectElementContents( document.getElementById('t1') );">Copy Table</button> -->



# Test GPU (doesn't work)

* http://www.r-tutor.com/gpu-computing/clustering/distance-matrix
* https://github.com/cdeterman/gpuR/wiki/Build-Instructions-for-Linux
  
```{r, eval = FALSE}

test.data <- function(dim, num, seed = 17){
  set.seed(seed)
  matrix(rnorm(dim * dim), nrow = num)
}

m <- test.data(1200, 45000)

system.time(dist(m))


# Dev RViennaCL
devtools::install_github("cdeterman/RViennaCL")

# Dev gpuR
devtools::install_github("cdeterman/gpuR")


A <- seq.int(from=0, to=999)
B <- seq.int(from=1000, to=1)
gpuA <- gpuVector(A)
gpuB <- gpuVector(B)

C <- A + B
gpuC <- gpuA + gpuB

all(C == gpuC)


```

# Environment

```{r}

sessionInfo()

```
