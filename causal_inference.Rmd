---
title: "Causal Inference"
author: "Wu Gong"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    code_folding: hide
    toc_depth: 6
    lightbox: true
    gallery: false
    highlight: monochrome
    css: Wu.css
---


	
```{r setup, echo=FALSE, cache=FALSE,warning=FALSE,message=FALSE}
library(knitr)
library(rmdformats)
library(Wu)
opts_chunk$set(echo=TRUE
             , cache=FALSE
             , eval=TRUE
             , prompt=FALSE
             , results="asis"
             , tidy=FALSE
             , comment=NA
             , message=FALSE
             , warning=FALSE
             , out.width = '80%'
             , class.source='klippy'
               )
eval_fast <- TRUE
eval_slow <- FALSE
klippy::klippy(position = c('top', 'left')
             , tooltip_message = 'Click to copy'
             , tooltip_success = 'Done')
```




# [Back to Index](index.html)


# Simulate Data


 * Assume a severity variable increases the treatment selection by an odds ratio of 1.5
 * The baseline probability of getting treatment is 0.2
 * The severity variable also increase the outcome risk by an odds ratio of 2
 * The treatment reduces the outcome risk by by an odds ratio of 0.5
 * The baseline probaiblity of outcome (death) is 0.2

```{r}
n <- 500
dt <- data.table(severity = rnorm(n), covar1 = rnorm(n), covar2 = rnorm(n), covar3 = rnorm(n))
p0 <- 0.2
or_trt <- 1.5
dt <- dt[, odds_trt_0 := p0 / (1 - p0)
         ][, log_odds_trt := log(odds_trt_0) + severity * log(or_trt)
           ][, p_trt := exp(log_odds_trt) / (1 + exp(log_odds_trt))]

vsample <- function(p){
    sample(c(1, 0), size = 1, replace = TRUE, prob = c(p, 1 - p))
}

vsample <- Vectorize(vsample)

dt <- dt[, trt := vsample(p_trt)]

p <- 0.2
dt <- dt[, odds_outcome_0 := p / (1 - p)
         ][, log_odds_outcome := log(odds_outcome_0) + severity * log(0.5) + covar1 * log(2.5) + covar2 * log(1.5)
           ][, p_outcome := exp(log_odds_outcome) / (1 + exp(log_odds_outcome))]


dt <- dt[, outcome := vsample(p_outcome)]

```

# Treatment Model

```{r}
m_trt <- glm(trt ~ severity + covar1 + covar2 + covar3, data = dt, family = binomial(logit))

library(sjPlot)

tab_model(m_trt)

```


# Distribution of Propensity Score

```{r}
dt$pred <- m_trt$fitted.values

p1 <- dt[trt == 1]$pred
p0 <- dt[trt == 0]$pred

plot_ly(alpha = 0.5, xbins = list(start = 0, end = 1, size = 0.02)) %>%
  add_histogram(x = ~ p1
              , name = "Treated"
              , inherit = TRUE
              ## , xbins = seq(0, 1, 0.05)
                ) %>%
  add_histogram(x = ~ p0
              , name = "Not Treated"
              , inherit = TRUE
              ## , xbins = seq(0, 1, 0.05)
                ) %>%
    layout(barmode = "overlay"
         , xaxis = list(title = paste0("Predicted Probabilities of Being Treated"),
                      zeroline = FALSE),
         yaxis = list(title = "Count",
                      zeroline = FALSE))


ggplot(data=dt, aes(x=pred, colour=factor(trt))) +
  geom_density(alpha=0.5) +
  labs(y="Density",x="pred") +
  scale_y_continuous(breaks=NULL,label=c("")) +
    theme(legend.position=c(0.8,0.2))

```


# Multivarible Outcome Model


```{r}
m_outcome_mv <- glm(outcome ~ severity + trt + covar1 + covar2 + covar3, data = dt, family = binomial(logit))

tab_model(m_outcome_mv)


```


# Causal Forest


 * grf runs regression forest

```{r}
library(grf)
frml <- Wu::wu_formula(outcome = "", predictors = c("covar1", "covar2", "covar3", "trt", "severity"))
mmx <- model.matrix.lm(frml, data = dt)

X <- subset(mmx, select=-c(trt))
X <- subset(X, select = -c(1))
Y <- dt$outcome
W <- mmx[, "trt"]

rf <- causal_forest(X, Y, W
                  ## , clusters = dt[["department"]]
                  , Y.hat = NULL
                  , W.hat = NULL
                  , num.trees = 1000
                  , honesty = TRUE
                  , tune.parameters = "none"
                    ## , tune.parameters = c("sample.fraction", "mtry")
                    ## , tune.num.trees = 4000
                  , compute.oob.predictions = TRUE
                  , seed = 123456
                    )


ate <- average_treatment_effect(rf, method="AIPW", target.sample = c("all"))
ate_treated <- average_treatment_effect(rf, method="AIPW", target.sample = c("treated"))


rst <- rbind(c("Average Effect", ate)
           , c("Average Effect on Treated", ate_treated)
             )

rst <- as.data.table(rst)
colnames(rst) <- c("name", "estimate", "se")
rst <- rst[, estimate := as.numeric(estimate)
           ][, se := as.numeric(se)
             ][, lower := estimate - (qnorm(0.975) * se)
           ][, upper := estimate + qnorm(0.975) * se]



rst %>% prt(digits=3)


```



# R sessionInfo

```{r}
sessionInfo()

```

