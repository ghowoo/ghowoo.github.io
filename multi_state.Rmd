---
title: "Multi-State Model"
author: "Wu Gong"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    code_folding: hide
    toc_depth: 6
    lightbox: true
    gallery: false
    highlight: monochrome
    css: Wu.css
---


	
```{r setup, echo=FALSE, cache=FALSE,warning=FALSE,message=FALSE}
library(knitr)
library(rmdformats)
library(Wu)
opts_chunk$set(echo=TRUE
             , cache=FALSE
             , eval=TRUE
             , prompt=FALSE
             , results="asis"
             , tidy=FALSE
             , comment=NA
             , message=FALSE
             , warning=FALSE
             , out.width = '80%'
             , class.source='klippy'
               )
eval_fast <- TRUE
eval_slow <- FALSE
klippy::klippy(position = c('top', 'left')
             , tooltip_message = 'Click to copy'
             , tooltip_success = 'Done')
```


# [Back to Index](index.html)


# Multi-state model with msm package

 * Ref: [Multi-state modelling with R: the msm package](https://cran.r-project.org/web/packages/msm/vignettes/msm-manual.pdf)
 * Informative sampling times
   + Fixed: patients are observed at fixed time intervals specified in advance
   + Random: the sampling times are independent of the current state of the disease  
   + Doctor's care: the next sampling time is chosen on the basis of the current disease state (more severe ill patients are monitored more closely) 
   + Patient self-selection: patients decide to see doctors when they are in poor conditions
 * $$P(t) = Exp(tQ)$$
   + $P$ is the probability of transition during the time $t$
   + $Q$ is the transition intensity maxtrix
   + $Exp$ is the matrix exponential
 * Interval censored: in the intermittently-observed processess, the exact times of the state changes are usually interval censored, it is known to be within the bounded intervals.
 * Sojourn Time: a single period of occupancy
 
 
 
## CAV Data

Sharples et al. studied the progression of coronary allograft vasculopathy (CAV), a post-transplant deterioration of the arterial walls, using these data. Risk factors and the accuracy of the screening test were investigated using multi-state Markov and hidden Markov models.

 * 622 patients
 * Approximately each year after transplant, every patient has an angiograme when CAV could be diagnosed.
 * age: age at screen
 * dage: donor's age
 * sex: 0=male, 1=female
 * pdiag: primary diagnosis
 * cumrej: cumulative number of rejection episodes
 * firstobs: 1 = the first observation (transplant), 0 = later angiogram

L.D. Sharples, C.H. Jackson, J. Parameshwar, J. Wallwork, and S.R. Large. Diagnostic accuracy of coronary angiography and risk factors for post-heart-transplant cardiac allograft vasculopathy. Transplantation, 76(4):679682, 2003.

```{r}
library(msm)
cav %>% DT()

```

## Data Summary


```{r}


Vars <- c(
    "age"
  , "years"
  , "dage"
  , "sex"
  , "pdiag"
  , "cumrej"
  , "state"
)

FactorVars <- c(
    "sex"
  , "pdiag"
  , "cumrej"
  , "state"
)

t <- Table1n(obj = cav, Vars = Vars, FactorVars = FactorVars)

t %>% prt()

```


## Description


```{r}
dt <- cav
setDT(dt)
dt <- dt[, state := factor(state)][, years := as.integer(floor(years))]

clrs <- c("#2EAEE6"
        ## , "#2EE6CA"
        ## , "#2EE677"
        , "#37E62E"
        ## , "#8AE62E"
        , "#DCE62E"
        ## , "#E69C2E"
        , "#E6492E"
          ## , "#aaaaaa"
          )


ggplot(dt, aes(x=years, fill = state)) + geom_bar() +
    scale_fill_manual(values = clrs) +
    labs(x="Year of State"
       , y="Count"
       , title="Overall"
         ) +
    ## scale_x_discrete(breaks=seq(0, 20, 5)) +
    ## scale_y_continuous(breaks=seq(1, 5, 1)) +
    theme(panel.background = element_rect(fill = "transparent")
        , plot.background = element_rect(fill = "transparent", color = NA)
        , panel.grid.major = element_blank()
        , panel.grid.minor = element_blank()
        , legend.background = element_rect(fill = "transparent")
        , legend.box.background = element_rect(fill = "transparent")
        , legend.position = 'top'
        ## , plot.margin=unit(c(1,2,1,2),"cm")
          ) +
    ## coord_fixed(ratio = 3 / 2
              ## , xlim = c(0.5, 28.5)
              ## , ylim = c(0.5, 10.5)
              ## , expand = FALSE) +
    guides(fill = guide_legend(nrow = 1))



ggplot(dt, aes(x=years, fill = state)) + geom_bar(position = "fill") +
    scale_fill_manual(values = clrs) +
    labs(x="Year of State"
       , y="Count"
       , title="Proportiona by Sex"
         ) +
    ## scale_x_discrete(breaks=seq(0, 20, 5)) +
    ## scale_y_continuous(breaks=seq(1, 5, 1)) +
    facet_wrap(as.formula(paste0("~", "sex"))) + 
    theme(panel.background = element_rect(fill = "transparent")
        , plot.background = element_rect(fill = "transparent", color = NA)
        , panel.grid.major = element_blank()
        , panel.grid.minor = element_blank()
        , legend.background = element_rect(fill = "transparent")
        , legend.box.background = element_rect(fill = "transparent")
        , legend.position = 'top'
        ## , plot.margin=unit(c(1,2,1,2),"cm")
          ) +
    ## coord_fixed(ratio = 3 / 2
              ## , xlim = c(0.5, 28.5)
              ## , ylim = c(0.5, 10.5)
              ## , expand = FALSE) +
    guides(fill = guide_legend(nrow = 1))



```

## Simple bidirectional model

 * Death is the absorbing state
 * The day of death is assumed to be recorded exactly. The state 4 is death, deathexact=4
 * If the data has two death states 4 and 5 with two competing risks, deathexact=c(4,5)
 * State transition table: from state (in row) to state (in column)
 * Transition intensity matrix Q: zeros in the matrix
 * obstype: a vector specifying the observation scheme for each row of the data
     + =1: a snapthot of the process, the states are unkown between observation times
	 + =2: an exact transition time, the state at the previous observation retained untile the current observation
	 + =3: an exact transition time, but the state at the instant before entering this state is unknown.
	 + exacttime=TRUE: all observations are of obstype 2.
	 + deathexact=death.states specifies that all observations of death.states are of type 3.
	 + deathexact=TRUE specifies all observations in the final absorbing state are of type 3.

```{r}
library(msm)


t <- statetable.msm(state, PTNUM, data=cav)

t %>% as.data.frame.matrix() %>% prt(caption="Transition Frequencies")

Q <- rbind ( c(0, 0.25, 0, 0.25),
            c(0.166, 0, 0.166, 0.166),
            c(0, 0.25, 0, 0.25),
            c(0, 0, 0, 0) )


Q %>% prt(caption="Initial Transition Intensity")

cav.msm <- msm(state ~ years
             , subject = PTNUM
             , data = cav
             , qmatrix = Q
             , deathexact = 4)

pv <- summary(cav.msm)$prevalences

pv$Observed %>% prt(caption="Observed Frequencies")
pv$`Observed percentages` %>% prt(caption="Observed percentages")

pv$Expected %>% prt(caption="Expected Frequencies")
pv$`Expected percentages` %>% prt(caption="Expected percentages")



P <- pmatrix.msm(cav.msm, t=1, t1=0, ci="normal")

as.data.frame.matrix(P$estimates) %>% prt(caption="Transition Probabilities from time 0 to time 1")


prv <- prevalence.msm(
    cav.msm
  , times=5
  , timezero=NULL
  , initstates=NULL
  , covariates="population"
)


prv[["Expected percentages"]] %>% prt(caption="predicted prevalence percentage at time 5")

```

# Model Fitness


```{r}
plot.prevalence.msm(cav.msm)

```

## Model with Covariates

```{r}
cav.msm.1 <- msm(state ~ years
             , subject = PTNUM
             , data = cav
             , qmatrix = Q
             , deathexact = 4
             , covariates = ~ sex
               )

h1 <- hazard.msm(cav.msm.1)

h1$sex %>% prt(caption="Hazard Ratio of sex 1 against 0")

sj1 <- sojourn.msm(cav.msm.1, covariate=list(sex=1), ci="norm")
sj0 <- sojourn.msm(cav.msm.1, covariate=list(sex=0), ci="norm")

sj1 %>% prt(caption="Estimated Time for Each State sex=1")
sj0 %>% prt(caption="Estimated Time for Each State sex=0")

plot(cav.msm)
plot(cav.msm.1)
plotprog.msm(state ~ years, subject = PTNUM, data=cav)

```


## Model Comparison


```{r}
cav.msm <- msm(state ~ years
             , subject = PTNUM
             , data = cav
             , qmatrix = Q
             , deathexact = 4)

cav.msm.1 <- msm(state ~ years
             , subject = PTNUM
             , data = cav
             , qmatrix = Q
             , deathexact = 4
             , covariates = ~ sex
               )

t <- lrtest.msm(cav.msm, cav.msm.1)

t %>% prt(caption="Likelihood Ratio Test: Null model vs sex model"
          , col.names=attr(t, "dimnames")[[2]]
          )

```


# Individual continuous time state transition model


 * R hesim package: https://arxiv.org/pdf/2102.09437.pdf



## Simulating Individual Patient Data

```{r}


library(hesim)
library("data.table")
n_patients <- 1000
patients <- data.table(
    patient_id = 1:n_patients,
    age = rnorm(n_patients, mean = 45, sd = 7),
    female = rbinom(n_patients, size = 1, prob = .51)
)

states <- data.table(
    state_id = c(1, 2),
    state_name = c("Stable", "Progression")
)


strategies <- data.table(
    strategy_id = 1:3,
    strategy_name = c("SOC", "New 1", "New 2"),
    soc = c(1, 0, 0),
    new1 = c(0, 1, 0),
    new2 = c(0, 0, 1)
)


hesim_dat <- hesim_data(
    strategies = strategies,
    patients = patients,
    states = states
)

get_labels(hesim_dat)


```

# Computing Environment


```{r}
sessionInfo()
```
