---
title: "Run Python in RMarkdown"
author: "Wu Gong"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    code_folding: hide
    toc_depth: 6
    lightbox: true
    gallery: false
    highlight: monochrome
    css: Wu.css
---



# [Index](index.html)


# Setup

 * library(reticulate)
 * use_virtualenv("py39bert")
 * knitr::knit_engines$set(python = reticulate::eng_python)


# Setup

 * Create virtual evironment "rmd" using default python python3.7
 * Automatically install pip, wheel, setuptools, numpy
 * install python packages: py_install("package-name", envname = "rmd")
 * use_virtualenv("rmd")
 * set knitr_engines using reticulate

```{r setup, echo=FALSE, cache=FALSE,warning=FALSE,message=FALSE}
library(knitr)
library(rmdformats)
library(Wu)
opts_chunk$set(echo=TRUE,
               cache=FALSE,
               eval=TRUE,
               prompt=FALSE,
               results="asis",
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               out.width = '80%')
eval_fast <- TRUE
eval_slow <- FALSE
library(reticulate)
## use_condaenv("rmd")
use_virtualenv("py39bert")
## reticulate::install_miniconda()
## virtualenv_create("rmd")
## py_install("seaborn", envname = "rmd")
## use_virtualenv("rmd")
##use_virtualenv("py3-virtualenv")
## py_config()
## py_available()
knitr::knit_engines$set(python = reticulate::eng_python)
```



# Data Transfer

```{r}
library(feather)
library(Wu)
dt <- data.table(v1=1:6, v2=rep("A", 6))
write_feather(dt, "dt.feather")


```

# Install package

```{r}
library(reticulate)
use_virtualenv("py39bert")
## virtualenv_install("py39bert", "feather")

```

# Read feather in Python

```{python}

import pandas as pd
import feather
path = "dt.feather"

df = pd.read_feather(path)

print(df)

```

# Conda Installation

 * conda_create: create new env using conda
 * virtualenv_create: using virtualenv
 

```{r}
library(reticulate)

## repl_python()
conda_list()

## conda_create("rmd")

## reticulate::conda_remove("base")
## conda_remove("rmd")

## use_condaenv("rmd")

## conda_install(envname="rmd", packages="matplotlib")


## virtualenv_list()
## virtualenv_remove("rmd")
## virtualenv_create("rmd")
## virtualenv_install(envname="rmd", packages="scipy")

```

# Check Python env

 * py_config: see current python version

```{r}


## use_virtualenv("py39bert")
## virtualenv_install(envname="py39bert", packages="scipy")
## py_config()

## os <- import("os")
## os$environ
## os$environ['HOME']

## os$listdir()


```


# reticulate

 * virtualenv_list() lists virtual environment
 * use_virtualenv("virtual-environment-name"): initiate python from virtual-environment, required = TRUE check if there is the version, otherwise may search for other versions
 * use_python("python path"): initiated python from path
 * py_config() to see version
 
 
 
```{r, eval = FALSE}


## library(reticulate)


## Sys.setenv(RETICULATE_PYTHON = "/home/gongw/.virtualenvs/pybert/bin/python3.9")
## Sys.setenv(LD_LIBRARY_PATH = paste(
##              "/home/gongw/.virtualenvs/pybert/lib"
##            , Sys.getenv("LD_LIBRARY_PATH")
##            , sep = ":"))
## use_python("/home/gongw/.virtualenvs/pybert/bin/python3.9")

library(reticulate)
## use_python("/home/gongw/.virtualenvs/py39bert/bin/python3.9")
## use_python("/usr/bin/python3")

use_virtualenv("py39bert")

py_config()
py_discover_config()
## py_install()


## reticulate::py_config()


## virtualenv_list()
## reticulate::use_python("/usr/bin/python3")
## use_virtualenv("py39bert", required = TRUE)
## py_available()

## reticulate::use_python("~/venv/pybert/bin/python3")

os <- import("os")
os$listdir(".")
sys <- import("sys")
sys$version


## py_install("pandas")
#py_install("pandas", method = "auto", conda = "auto")

```

# python matplotlib

```{python}


print(4)


import sys
print(sys.version)

import seaborn as sns
pr = sns.load_dataset("fmri")
import matplotlib as mpl
sns.lmplot("timepoint", "signal", data = pr)
mpl.pyplot.show()
# print(pr)

x=4
print(x)


```

```{r}


## py_get_item(x)
## print(py$x)

## f1 <- subset(py$fmri, region = "parietal")

y <- 5
```

```{python}
import matplotlib as mpl
# sns.lmplot("timepoint", "signal", data = r.f1)
# mpl.pyplot.show()

```

# Python chunk

```{python}

import numpy as np
x = np.arange(5)
print(x)


```

# Install Packages within Python 


```{r, eval = FALSE}
## try:
##     import seaborn
## except ImportError:
##     from pip._internal import main as pip
##     pip(['install', 'seaborn'])
##     import seaborn


# from pip._internal import main as pip
# pip(['install', 'seaborn'])

```



# Python print



```{python}


x = 'hello, python world!'
print(x)

import numpy as np
a = np.arange(5)
print(a)


```



# Python plot

```{python}

import matplotlib.pyplot as plt
fig, ax = plt.subplots( nrows=1, ncols=1 )
ax.plot([0,1,2], [10,20,3])
#ax.show()
# plt.plot([1,2,3],[3,4,5])
# plt.show()

fig.savefig("pythton_pyplot.png")
plt.close(fig)
```


![matplot](pythton_pyplot.png)
